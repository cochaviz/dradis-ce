<% if @success -%>
  data = {
    file: '<%= @attachment.filename %>',
    uploader: '<%= params[:uploader] %>'
  };
  <% if @state %>
    data.state = '<%= @state %>';
  <% end %>

  url = $('#new_upload').data('parse-url');
  $.post(url, data, function(response) {
    ConsoleUpdater.jobId = response['job_id']

    $('#result').data('id', ConsoleUpdater.jobId)
    $('#result').show()
    $('#item_id').val(ConsoleUpdater.jobId)

    $('#filesize').text('<%=j number_to_human_size( File.size(@attachment.fullpath) ) %>');
    $('#spinner').hide();
    ConsoleUpdater.parsing = true;
  }, 'json');

  $('#attachment').val('<%= @attachment.filename %>');
  setTimeout(ConsoleUpdater.updateConsole, 1000);
<% else -%>
  $("#<%= @item_id  %>").find('span').html('(<%=h flash.now[:error] %>)');
<% end -%>
