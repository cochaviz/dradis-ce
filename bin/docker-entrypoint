#!/bin/bash -e
echo 'Preparing the database...'
./bin/rails db:prepare

if [ ! -f $SSL_KEY_FILE ] || [ ! -f $SSL_CERT_FILE ]; then
  echo 'SSL certificates not found, generating self-signed certificates...'

  echo "server_ip: $SERVER_IP"

  openssl req -x509 \
    -newkey rsa:4096 \
    -nodes \
    -keyout $SSL_KEY_FILE \
    -out $SSL_CERT_FILE \
    -days 3650 \
    -subj "/C=GB/ST=London/L=London/O=Security Roots Ltd/OU=Dradis CE/CN=$SERVER_IP" \
    -addext "subjectAltName=DNS:$SERVER_IP"

else
  echo 'SSL certificates found, skipping generation...'
fi

exec "${@}"
